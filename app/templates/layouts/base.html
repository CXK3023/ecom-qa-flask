<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}电商问答系统{% endblock %}</title>
    {# === 引入 Bootstrap CSS === #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    {# (可选) 引入 Bootstrap Icons CSS (如果需要使用 bi-* 图标) #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    {# (可选) 你可以添加自己的 CSS 文件链接在这里 #}
    <style>
        /* 保留一些自定义样式，或者后续可以移到单独的 CSS 文件 */
        body { padding-bottom: 100px; /* 稍微增加底部内边距，给固定问答区留空间 */ }
        /* 调整固定问答区样式，可以根据喜好修改 */
        .qa-fixed-bottom {
            max-height: 200px; /* 限制最大高度 */
            overflow-y: hidden; /* 默认隐藏滚动条 */
            transition: max-height 0.3s ease-in-out; /* 添加过渡效果 */
        }
        .qa-fixed-bottom:hover {
            max-height: 400px; /* 鼠标悬停时展开 */
            overflow-y: auto; /* 悬停时允许滚动 */
        }
        /* 确保内容区不会被固定页脚遮挡 */
        main.container { margin-bottom: 100px; }
    </style>
</head>
<body>
    {# === 使用 Bootstrap 导航栏 === #}
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-4 shadow-sm"> {# 添加一点阴影 #}
          <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main.index') }}"><i class="bi bi-chat-left-dots-fill text-primary"></i> 电商问答系统</a> {# 添加图标 #}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  {# 根据当前请求路径判断是否为首页，添加 active 类 #}
                  <a class="nav-link {% if request.endpoint == 'main.index' %}active{% endif %}" aria-current="page" href="{{ url_for('main.index') }}">首页</a>
                </li>
                {# 可以在这里添加其他公共导航链接，例如商品分类等 #}
                {# <li class="nav-item"> <a class="nav-link" href="#">所有商品</a> </li> #}
              </ul>
              <ul class="navbar-nav">
                {% if current_user.is_authenticated %}
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownUserLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-person-circle"></i> 你好, {{ current_user.username }}!
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownUserLink">
                      <li><a class="dropdown-item {% if request.endpoint == 'main.profile' %}active{% endif %}" href="{{ url_for('main.profile') }}"><i class="bi bi-person-lines-fill"></i> 个人资料</a></li>
                      <li><a class="dropdown-item {% if request.endpoint == 'main.change_username' %}active{% endif %}" href="{{ url_for('main.change_username') }}"><i class="bi bi-person-check"></i> 修改用户名</a></li>
                      <li><a class="dropdown-item {% if request.endpoint == 'main.change_email' %}active{% endif %}" href="{{ url_for('main.change_email') }}"><i class="bi bi-envelope-at"></i> 修改邮箱</a></li>

                      {# === 管理员专属菜单项 - 条件修改 === #}
                      {# === vvv MODIFY START vvv === #}
                      {% if current_user.role == 'admin' or current_user.id == 1 %}
                      {# === ^^^ MODIFY END ^^^ === #}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item {% if request.endpoint == 'admin.list_rules' %}active{% endif %}" href="{{ url_for('admin.list_rules') }}"><i class="bi bi-gear-fill"></i> 规则管理</a></li>
                        <li><a class="dropdown-item {% if request.endpoint == 'admin.list_users' %}active{% endif %}" href="{{ url_for('admin.list_users') }}"><i class="bi bi-people"></i> 用户管理</a></li>
                        <li><a class="dropdown-item {% if request.endpoint == 'admin.list_all_products' %}active{% endif %}" href="{{ url_for('admin.list_all_products') }}"><i class="bi bi-box-seam"></i> 商品管理</a></li>
                      {% endif %}
                      {# === 管理员菜单项结束 === #}

                      {# --- 商家中心链接 --- #}
                      {# 仅当用户角色是'seller'时显示，不受 admin 或 id=1 影响 #}
                      {% if current_user.role == 'seller' %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item {% if request.blueprint == 'seller' %}active{% endif %}" href="{{ url_for('seller.dashboard') }}"><i class="bi bi-shop"></i> 商家中心</a></li>
                      {% endif %}
                      {# --- 商家中心链接结束 --- #}

                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                    </ul>
                  </li>
                {% else %}
                  <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'auth.register' %}active{% endif %}" href="{{ url_for('auth.register') }}">注册</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'auth.login' %}active{% endif %}" href="{{ url_for('auth.login') }}">登录</a>
                  </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </nav>
    </header>

    {# === 使用 Bootstrap Alert 显示 Flash 消息 === #}
    <div class="container"> {# 将 flash 消息容器移到这里，只出现一次 #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set alert_type = 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' if category == 'warning' else 'info' %} {# Added warning type #}
                    <div class="alert alert-{{ alert_type }} alert-dismissible fade show mt-3" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    {# === 主体内容区域，使用 Bootstrap 容器 === #}
    <main class="container mt-4">
        {% block content %}
        {# 子模板的内容会在这里填充 #}
        {% endblock %}
    </main>

    {# === 智能问答助手区域 (固定在底部) === #}
    <div class="container fixed-bottom bg-body-tertiary border-top pt-3 qa-fixed-bottom shadow-lg"> {# 使用 bg-body-tertiary 适应主题，添加阴影 #}
         <h5><i class="bi bi-robot"></i> 智能问答助手</h5>
         <div class="input-group mb-2">
             <input type="text" id="qa-input" class="form-control form-control-sm" placeholder="有问题问 AI..." aria-label="问答输入框">
             <button class="btn btn-sm btn-primary" type="button" id="qa-button"><i class="bi bi-send"></i> 发送</button>
         </div>
         <div id="qa-status" class="text-muted small mb-1" style="min-height: 1.2em;"></div>
         <div id="qa-answer" class="alert alert-light alert-sm small p-2 border" role="alert" style="min-height: 40px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 10px; background-color: #f8f9fa;"> {# 使用更浅的背景 #}
             你好！有什么可以帮你的吗？
         </div>
     </div>
    {# === 智能问答助手区域结束 === #}


    <footer class="container mt-5 py-3 text-center text-muted border-top small"> {# 页脚文字改小 #}
        {# 尝试在后端传递当前年份 #}
        <p>&copy; 2025 电商问答系统. All Rights Reserved.</p>
    </footer>

    {# === 引入 Bootstrap JS (必须放在 </body> 前) === #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {# ====================================================== #}
    {# !!! 下面是处理问答交互的 JavaScript 代码 (已修改) !!! #}
    {# ====================================================== #}
    <script>
        // 等待整个页面加载完毕再执行脚本
        document.addEventListener('DOMContentLoaded', function() {
            console.log("页面脚本开始加载...");

            // 通过 ID 获取 HTML 元素
            const qaInput = document.getElementById('qa-input');
            const qaButton = document.getElementById('qa-button');
            const qaStatus = document.getElementById('qa-status');
            const qaAnswerDiv = document.getElementById('qa-answer');

            // --- 定义处理提问的函数 ---
            function handleQuestionSubmit() {
                console.log("提问按钮被点击！handleQuestionSubmit 函数开始执行...");
                // 确保元素都找到了再执行
                if (!qaInput || !qaButton || !qaStatus || !qaAnswerDiv) {
                    console.error("错误：未能找到所有问答区的 HTML 元素！");
                    return;
                }

                const questionText = qaInput.value.trim();
                if (!questionText) {
                    qaStatus.textContent = '请输入你的问题！';
                    qaInput.focus();
                    // 短暂显示提示后清除
                    setTimeout(() => { if(qaStatus.textContent === '请输入你的问题！') qaStatus.textContent = ''; }, 2000);
                    return;
                }

                // --- 开始发送请求 ---
                qaAnswerDiv.textContent = ''; // 清空旧答案
                // 使用 Bootstrap Spinner 作为加载提示
                qaStatus.innerHTML = `<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">思考中...</span></div><span class="ms-1 small">正在思考中...</span>`; // 使用 primary 颜色
                qaButton.disabled = true;
                qaInput.disabled = true;
                qaInput.value = ''; // 点击发送后清空输入框

                // --- 准备要发送的数据 ---
                let requestData = {
                    question: questionText // 包含用户的问题
                };

                // === 检查并添加 product_id ===
                const productIdInput = document.getElementById('product-id-context');
                if (productIdInput && productIdInput.value) {
                    requestData.product_id = productIdInput.value;
                    console.log("提问上下文中包含商品ID:", requestData.product_id);
                } else {
                    console.log("当前页面没有找到 product-id-context，按通用问题处理。");
                }
                // === 检查并添加 context_type (例如来自商家后台) ===
                const contextTypeInput = document.getElementById('context-type'); // 查找 id='context-type' 的隐藏输入框
                if (contextTypeInput && contextTypeInput.value) {
                    requestData.context_type = contextTypeInput.value; // 添加 context_type
                    console.log("提问上下文中包含 context_type:", requestData.context_type);
                }

                // --- 使用 fetch API 发送 POST 请求到后端 ---
                fetch('/qa/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                             throw new Error(errData.error || `请求失败，状态码: ${response.status}`);
                         }).catch(() => {
                             throw new Error(`请求失败，状态码: ${response.status}`);
                         });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("收到后端数据:", data);
                    qaStatus.innerHTML = ''; // 清空加载状态
                    if (data && data.answer) {
                        qaAnswerDiv.textContent = data.answer;
                        qaAnswerDiv.scrollTop = 0; // 回答后滚动到顶部
                    } else {
                        qaAnswerDiv.textContent = '抱歉，未能获取到有效的回答。';
                    }
                })
                .catch(error => {
                    console.error('请求 AI 回答时出错:', error);
                    qaStatus.innerHTML = ''; // 清空加载状态
                    qaAnswerDiv.textContent = `获取回答失败: ${error.message}. 请检查网络或联系管理员。`;
                })
                .finally(() => {
                    console.log("请求处理完成。");
                    qaButton.disabled = false;
                    qaInput.disabled = false;
                    qaInput.focus(); // 让用户可以继续输入
                });
            } // --- handleQuestionSubmit 函数定义结束 ---

            // --- 事件监听器绑定 ---
            if (qaButton) {
                qaButton.addEventListener('click', handleQuestionSubmit);
                console.log("已为 qaButton 添加点击事件监听器。");
            } else {
                console.error("错误：找不到 qa-button 元素！");
            }

            if (qaInput) {
                qaInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        console.log("检测到回车键，触发提问。");
                        handleQuestionSubmit();
                    }
                });
                console.log("已为 qaInput 添加回车键监听器。");
            } else {
                console.error("错误：找不到 qa-input 元素！");
            }

            // --- (新增) 处理特定页面的 JavaScript (例如商家后台) ---
            // 我们将特定页面的 JS 移到各自的模板中，以避免冲突
            // 这里只保留通用的 base.html 的问答逻辑

             // --- 处理商家问答区的 JavaScript (从 seller/dashboard 移到这里可能更好管理，但暂时按原样) ---
             // (如果需要全局处理，则取消注释并适应下面代码)
             /*
             const sellerQaInput = document.getElementById('seller-qa-input');
             const sellerQaButton = document.getElementById('seller-qa-button');
             const sellerQaStatus = document.getElementById('seller-qa-status');
             const sellerQaAnswerDiv = document.getElementById('seller-qa-answer');
             const contextTypeInput = document.getElementById('context-type'); // Assume only one context type input for simplicity here

             function handleSellerQuestionSubmit() {
                 // ... (Logic similar to handleQuestionSubmit, but using seller-* IDs and sending context_type)
                 console.log("商家提问按钮点击！");
                 if (!sellerQaInput || !sellerQaButton || !sellerQaStatus || !sellerQaAnswerDiv || !contextTypeInput) {
                     console.error("错误：未能找到所有商家问答区的 HTML 元素！");
                     return;
                 }
                 // ... rest of the logic ...
             }

             if (sellerQaButton) {
                 sellerQaButton.addEventListener('click', handleSellerQuestionSubmit);
                 console.log("已为 sellerQaButton 添加点击事件监听器。");
             }
             if (sellerQaInput) {
                 sellerQaInput.addEventListener('keypress', function(event) {
                     if (event.key === 'Enter' && !event.shiftKey) {
                         event.preventDefault();
                         handleSellerQuestionSubmit();
                     }
                 });
                 console.log("已为 sellerQaInput 添加回车键监听器。");
             }
            */

        }); // --- DOMContentLoaded 事件监听结束 ---
    </script>
    {# === script 块结束 === #}

</body>
</html>